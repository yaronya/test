version: 1

deploy:
  steps:
    setupVariables:
      after:
        - curl -L -o opa https://openpolicyagent.org/downloads/v0.46.1/opa_linux_amd64_static
        - chmod 755 ./opa

    terraformPlan:
      after:
        - pwd
        - cd .. && pwd
        - pwd
        - terragrunt show -json ../.env0workdir/.tf-plan >> tfplan.json
        - ./opa eval --format pretty -i tfplan.json -d ./opa-policies/aws/tag_resources.rego --fail "data.aws.tagging.violation"
